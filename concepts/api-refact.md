# Рефакторинг всех модулей API

> **Автор:** [Михаил Краснов](https://github.com/Linuxoid85)

> **E-mail:** [linuxoid85@gmail.com](mailto:linuxoid85@gmail.com)

> **Категория:** Рефакторинг кода.

## Причины

Нелогичность, непродуманность и несвязность каждого модуля API.

## Список необходимых модулей

- `cp_default`;
- `cp_blacklists`;
- `cp_info`;
- `cp_install`;
- `cp_remove`;
- `cp_update`.

## Требуемый рефакторинг

### Архитектура

1. **Язык:** Python.
2. **Интерпретатор:** cpython-3.10
3. **БД:** SQLite3
4. **Дистрибутив GNU/Linux:** Calmira GNU/Linux-libre
5. **Необходимые для базового функционала модули:**
    - os
    - sys
    - json
    - shutil
    - subprocess
    - time
    - configparser
    - sqlite3
    - wget
    - tarfile
6. **Необходимые для реализации модули API:**
    - cp_blacklists - взаимодействие с базой данных чёрного списка
    - cp_default - общие функции, константы и объявления для всех модулей API
    - cp_info - методы для получения информации о портах
    - cp_install - сборка и установка портов
    - cp_remove - удаление портов
    - cp_update - обновление *системы портов*
    - ports.sh - Shell-скрипт, содержащий общие функции для сборочных инструкций портов

### `cp_default`

- Причины рефакторинга

1. Нелогичность названий некоторых классов (например, класс `log()` содержит функции не только для логирования, но и для вывода всевозможных сообщений).
2. Необходимость создания отдельных экземпляров классов (например, `check()`). Там, где совершенно не нужно.

- Требуемые изменения

1. Разделение класса `log()` на несколько новых:
    1. `log()` - содержит методы **только** для логирования системы портов. Среди методов должно быть реализовано следующее:
        - `__init__(self, dir=LOG_DIR, file=LOG_FILE)`.
        - `check(file=None, dir=None)` - проверка существования необходимых файлов логов или директорий с этими файлами, а так же прав доступа к ним;
        - `log(message, level="UKNOWN")` - создание логов и их запись в указанный файл.
    2. `msg()` - содержит методы для формирования всевозможных сообщений. Среди методов должно быть реализовано:
        - `error(self, message, prev="", log=False, func=None)` - для формирования сообщений об ошибке.
        - `dialog(self, default_no=False) -> bool` - создание диалоговых сообщений о продолжении работы каких-либо операций.
2. Перенос метода `dialog()` в класс `msg()`.
3. Приведение в порядок класса `check()`:
    - Удаление метода `_get_calm_release()` ввиду его неактуальности (эта функция использовалась для проверки обновлений системы портов, сейчас же планируется переработать механизм обновления, избавившись от неудобного формата метаданных с `update_number`);
    - Добавить проверки на корректность файла `config.json` порта, который проверяется.
4. Изменить поведение класса `settings()`:
    1. Переименовать метод `p_set()` в `config_param_set()` - это название более логично.
    2. Убрать во всех методах именованный аргумент `source`, поместить его в `__init__(source=CONFIG)`.