# Рефакторинг всех модулей API

> **Автор:** [Михаил Краснов](https://github.com/Linuxoid85)

> **E-mail:** [linuxoid85@gmail.com](mailto:linuxoid85@gmail.com)

> **Категория:** Рефакторинг кода.

## Причины

Нелогичность, непродуманность и несвязность каждого модуля API. Плохо читабельный и нелогичный код некоторых модулей.

## Список необходимых модулей

- `cp_default`;
- `cp_blacklists`;
- `cp_info`;
- `cp_install`;
- `cp_remove`;
- `cp_update`.

## Требуемый рефакторинг

### Архитектура

1. **Язык:** Python.
2. **Интерпретатор:** cpython-3.10
3. **БД:** SQLite3
4. **Дистрибутив GNU/Linux:** Calmira GNU/Linux-libre
5. **Необходимые для базового функционала модули:**
    - os
    - sys
    - json
    - shutil
    - subprocess
    - time
    - configparser
    - sqlite3
    - wget
    - tarfile
6. **Необходимые для реализации модули API:**
    - cp_blacklists - взаимодействие с базой данных чёрного списка
    - cp_default - общие функции, константы и объявления для всех модулей API
    - cp_info - методы для получения информации о портах
    - cp_install - сборка и установка портов
    - cp_remove - удаление портов
    - cp_update - обновление *системы портов*
    - ports.sh - Shell-скрипт, содержащий общие функции для сборочных инструкций портов

### `cp_default`

- Причины рефакторинга

1. Нелогичность названий некоторых классов (например, класс `log()` содержит функции не только для логирования, но и для вывода всевозможных сообщений).
2. Необходимость создания отдельных экземпляров классов (например, `check()`). Там, где совершенно не нужно.

- Требуемые изменения

1. Разделение класса `log()` на несколько новых:
    1. `log()` - содержит методы **только** для логирования системы портов. Среди методов должно быть реализовано следующее:
        - `__init__(self, dir=LOG_DIR, file=LOG_FILE)`.
        - `check(file=None, dir=None)` - проверка существования необходимых файлов логов или директорий с этими файлами, а так же прав доступа к ним;
        - `log(message, level="UKNOWN")` - создание логов и их запись в указанный файл.
    2. `msg()` - содержит методы для формирования всевозможных сообщений. Среди методов должно быть реализовано:
        - `error(self, message, prev="", log=False, func=None)` - для формирования сообщений об ошибке.
        - `dialog(self, default_no=False) -> bool` - создание диалоговых сообщений о продолжении работы каких-либо операций.
2. Перенос метода `dialog()` в класс `msg()`.
3. Приведение в порядок класса `check()`:
    - Удаление метода `_get_calm_release()` ввиду его неактуальности (эта функция использовалась для проверки обновлений системы портов, сейчас же планируется переработать механизм обновления, избавившись от неудобного формата метаданных с `update_number`);
    - Добавить проверки на корректность файла `config.json` порта, который проверяется.
4. Изменить поведение класса `settings()`:
    1. Переименовать метод `p_set()` в `config_param_set()`, метод `get()` в `config_param_get()` - эти названия более логичны.
    2. Убрать во всех методах именованный аргумент `source`, поместить его в `__init__(source=CONFIG)`.
    3. Так как configparser очень плохо работает с выбором возвращаемых типов данных, и, по сути, доступен один лишь `str`. Приводить тип данных возвращаемых значений не только к `str`, но и к `int`, `float`, `turple`, `list`.
        - Для автоматического определения типа данных возвращаемого значения метода `settings.get()`, требуется в конце параметра в конфиге добавлять конструкции `_s` (для `str`), `_i` (для `int`), `_f` (для `float`), `_l` (для `list`), `_t` (для `turple`), `_b` (для `bool`) - см. "Приложение 1".
        - Реализовать для автоматического определения типов данных отдельный метод `settings._get_type(param)`, возвращающий название типа данных.

## `cp_blacklists`

- Причины рефакторинга

1. Нелогичность кода, несоответствие всему остальному коду.
2. Наличие устаревших методов, которые нигде не используются.

- Требуемый рефакторинг

1. Добавить класс `check()`, содержащий методы для проверки наличия порта в чёрном списке и методы для проверки приоритета порта.
    1. Метод `exists()` для проверки наличия порта в базе данных чёрного списка;
    2. Метод `priority()` для проверки приоритета порта.
2. Добавить класс `blacklist()`, содержащий методы для добавления и удаления портов из базы данных чёрного списка.
    1. Метод `add()` для добавления порта в БД;
    2. Метод `remove()` для удаления порта из БД;

## Приложения

### Приложение 1 - пример конфига с параметрами, значения которых автоматически определяются методами `settings()`

```ini
[section1]
param = 0   ; Будет возвращён str, так как это тип данных по умолчанию
param_s = 0 ; Будет возвращён str, так как указан суффикс _s
param_i = 0 ; Будет возвращён int, так как указан суффикс _i
param_f = 0 ; Будет возвращён float, так как указан суффикс _f
param_l = "0 2 3" ; Будет возвращён list, так как указан суффикс _l *
param_t = "0 2 3" ; Будет возвращён turple, так как указан суффикс _t *
param_b = true  ; Будет возвращён bool (True), так как указан суффикс _b
param_b = false ; Будет возвращён bool (False), так как указан суффикс _b
```

> `*` - тип данных в возвращённых списке и кортеже должен быть `str`
