# Обновление системы портов

Самой главной идеей `port-utils`, а теперь и `cport` является обновление как системы портов, так и установленных портов. На данном этапе требуется только возможность обновления системы портов, после - обновление и всех установленных портов.

## `metadata.json`

Информация о каждом обновлении содержится в файле `metadata.json`, находящимся в репозитории системы портов. Структура файла:

```json
{
    "system_version": "1.1",
    "ports_stable": "https://github.com/CalmiraLinux/Ports/raw/stable",
    "ports_unstable": "https://github.com/CalmiraLinux/Ports/raw/testing",
    "port_file": "ports.txz",
    "updates": [
    ],
    "addings": [
    	"Port information files"
    ],
    "removes": [
    ],
    "prev": "commit id",
    "update_number": 3
}
```

Где:

- `system_version` - версия системы, для которой предназначено обновление;
- `ports_stable` - стабильная ветка (планируется удалить, ввиду использования значения из параметров cport);
- `ports_unstable` - нестабильная ветка (планируется удалить, ввиду использования значения из параметров cport);
- `port_file` - архив с системой портов, который требуется скачать во время обновления;
- `updates` - список обновлений портов;
- `addings` - список добавленных портов;
- `removes` - список удалённых портов;
- `update_number` - номер обновления;
- `prev` - ID коммита с предыдущим обновлением системы портов.

## Процесс обновления системы портов

Для начала скачивается файл `metadata.json` в `/tmp`. После чего сравнивается `update_number` из скачанных метаданных и установленных. В случае, если разница больше нуля, значит, обновления есть. Если разница равна нулю, значит, обновлений нет, а если разница меньше нуля, то выполняется откат с нестабильной ветки на стабильную, чего делать не рекомендуется.

Если разница больше единицы, то нужно вывести и список предыдущих изменений через цикл, кол-во итераций которого должно равняться разнице `update_number`. В таком случае сформировать ссылку `ports_{stable/unstable}`+`prev` для скачивания метаданных из предыдущих коммитов и просмотра информации об изменениях там.

В том случае, если пользователь согласен с установкой обновлений, то произвести следующий порядок действий:

- Скачать и распаковать архив `port-_file`;
- Проверить его на корректность;
    - Проверить наличие всех указанных портов (для этого в систему портов добавить файл `ports.list`);
    - Проверить наличие необходимых файлов в портах;
- Удалить старую копию системы портов (`/usr/ports`);
- Установить новую копию системы портов;
- Установить скачанные метаданные;

## Процесс обновления установленных портов

К релизу 2.0 в планах добавить обновление не только системы портов, но и установленного оттуда программного обеспечения. принцип работы похож на обновление системы портов, но отличается следдующем:

1. Вместо вывода изменений заводятся два списка (`update_ports` и `delete_ports`), содержащие имена портов для обновления, а так же имена портов, которые удалены из системы портов.
2. Далее производится обращение к базе данных установленных портов (`installed.db`). Порты из списка `update_ports` проверяются на наличия в базе данных. Если порта нет, то из списка он удаляется.
3. После чего каждый порт собирается и устанавливается, и в случае удачной сборки в базе данных `installed.db` изменяются данные о нём (версия, сборщик, описание, релиз Calmira GNU/Linux, дата сборки).
4. В заключение, как и в пункте №2, проверяется список `delete_ports`, в котором должны остаться только установленные порты. В случае, если размер списка больше единицы, то вывести предупреждающее сообщение о том, что порты из списка рекомендуется удалить, так как они больше не входят в состав системы портов и не будут ни поддерживаться, ни обновляться в дальнейшем. В противном случае просто закончить процесс обновления.