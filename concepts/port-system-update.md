# Обновление системы портов посредством `cport`

> **Автор:** [Михаил Краснов](https://github.com/Linuxoid85)

> **E-mail:** [linuxoid85@gmail.com](mailto:linuxoid85@gmail.com)

> **Категория:** Добавление/изменение функционала.

В `cport` требуется модуль для обновления системы портов до новой версии.

## Строение пакета с системой портов

```
ports.txz
|--- metadata.xz # Архив с метаданными.
|--- ports.xz    # Архив с системой портов
```

### `metadata.xz`

`metadata.xz` содержит информацию о релизе системы портов. В нём содержится файл `config.json` с описанием обновления системы портов. Строение файла:

```json
{
    "date": "01.01.1970 00:00",
    "release": [
        "1.1",
        "1.2",
        "2.0"
    ]
}
```

- `date` - содержит дату формирования пакета с системой портов.
- `release` - релиз Calmira GNU/Linux, для которого предназначены порты. Это список значений.

### `ports.xz`

Этот архив содержит директорию `ports` с системой портов. Эта директория устанавливается в `/usr`.

***

## Принцип работы

### Этап 1. Проверка.

1. Сначала скачиваются метаданные (файл `metadata.json`). Из него сверяется `update_number` с установленными в системе метаданными.
    1.1. Если `update_number` скаченных метаданных больше, чем в установленных, то скаченные метаданные устанавливаются на место старых, с которыми велось сравнивание.
    1.2. Если `update_number` скаченных метаданных равен установленным, то изменений в системе портов нет, и обновление не производится.
    1.3. Если `update_number` скаченных метаданных меньше установленных, то это значит, что выполняется downgrade с ветки `devel` до ветки `stable`, и в таком случае обновление или устанавливается, или прерывается, в зависимости от параметров утилиты `cport`.

### Этап 2. Выведение списка изменений.

1. Сначала выводится список изменений из скаченных метаданных.
2. Если разница между `update_number` новых и старых метаданных больше единицы, то скачиваются предыдущие за новыми метаданными файлы и из них так же выводятся изменения.

### Этап 3. Установка обновлений.

1. Если пользователя всё устраивает, то скачивается архив с системой портов.
2. В случае успешного скачивания этот архив распаковывается в кеш и выполняется проверка на корректность всех портов из системы.
    2.1. В проверку входит наличие нужных файлов и корректность JSON-конфигов.
3. Если проверка прошла успешно, то производится установка распакованной системы портов.
    3.1. Удаляется директория `/usr/ports`;
    3.2. Копируется директория `ports` из кеша в `/usr`.

***

## Реализация

Все функции находятся в модуле `cp_update.py`. Необходимые классы:

- `update()` - проверка обновлений и вывод сведений об изменениях;
- `check()` - проверка системы портов на корректность;
- `upgrade()` - установка обновлений.

***

## Приложения

### Приложение 1. Процесс проверки системы портов на корректность и целостность.

В проверку должно входить:

1. Проверка на корректность архива с системой портов:
    - md5 суммы.
2. Проверка на наличие необходимых файлов:
    - `config.json`;
    - `resources.conf`;
    - `install`;
    - `files.list`.
3. Проверка на корректность конфигов:
    - `config.json`;
    - `resources.conf`.